<style>
    .profile-header {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .profile-avatar {
        width: 160px;
        height: 160px;
        object-fit: cover;
        border: 4px solid #fff;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.08);
    }

    .profile-stats {
        padding: 0.75rem 0;
        border-radius: 0.5rem;
    }

    .profile-stats .stat-item {
        border-right: 1px solid #dee2e6;
        padding: 0 1.5rem;
    }

    .profile-stats .stat-item:last-child {
        border-right: 0;
    }

    .profile-tabs {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        margin: 0;
        padding: 0;
        width: 100%;
    }

    .profile-tabs::-webkit-scrollbar {
        display: none;
    }

    .profile-tabs .nav-item {
        white-space: nowrap;
        flex: 1;
        text-align: center;
    }

    .profile-tabs .nav-link {
        font-weight: 500;
        color: #6c757d;
        padding: 0.75rem 0.5rem;
        border-bottom: 2px solid transparent;
        border-radius: 0;
    }

    .profile-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
        background-color: transparent;
    }

    @media (min-width: 768px) {
        .profile-tabs .nav-link {
            padding: 0.75rem 1rem;
        }
    }

    @media (max-width: 768px) {
        .profile-tabs .nav-link {
            padding: 0.6rem 0.8rem;
            font-size: 0.875rem;
        }

        .profile-tabs .nav-link i {
            margin-right: 0.25rem !important;
        }

        .post-header .dropdown {
            position: static;
        }

        .post-header .dropdown-menu {
            width: 200px;
            left: auto;
            right: 0;
        }

        .profile-header .card-body {
            padding: 1.25rem;
        }

        .btn-follow {
            min-width: 100px;
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
        }

        .profile-stats {
            margin: 0.5rem -0.5rem;
        }

        .post-card .card-body {
            padding: 1.25rem;
        }

        .post-card h4.card-title {
            font-size: 1.25rem;
        }

        .post-header {
            padding: 0.75rem 1.25rem;
        }

        .post-footer {
            flex-wrap: wrap;
        }

        .post-footer .btn {
            flex: 1 1 auto;
            padding: 0.375rem;
            font-size: 0.875rem;
        }
    }

    @media (max-width: 576px) {
        .profile-avatar {
            width: 100px;
            height: 100px;
            margin: 0 auto 1rem;
        }

        .profile-header h2 {
            font-size: 1.5rem;
            text-align: center;
        }

        .profile-header .text-muted {
            text-align: center;
            display: block;
            width: 100%;
        }

        .col-lg-9 .text-muted {
            text-align: center;
        }

        .profile-username {
            text-align: center;
            display: block;
            width: 100%;
        }

        .profile-stats {
            padding: 0.5rem 0;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .profile-stats .stat-item {
            padding: 0.5rem 0.75rem;
            border-right: none;
            margin-bottom: 0.5rem;
            flex: 0 0 33.333%;
        }

        .d-flex.flex-wrap.mb-4 {
            justify-content: center;
            text-align: center;
        }

        .user-card .card-body {
            flex-direction: column;
            text-align: center;
        }

        .user-card .user-avatar {
            margin: 0 auto 1rem;
        }

        .profile-tabs .nav-link span {
            display: none;
        }

        .profile-tabs .nav-link i {
            margin-right: 0 !important;
            font-size: 1.25rem;
        }

        .profile-tabs .nav-link {
            padding: 0.75rem;
        }

        .post-header .d-flex {
            flex-wrap: wrap;
        }

        .post-header h5 {
            width: 100%;
            margin-top: 0.75rem;
        }

        .card-footer.post-footer {
            padding: 0.75rem;
        }

        .card-footer.post-footer .btn {
            font-size: 0.75rem;
            padding: 0.375rem 0.25rem;
        }

        .card-footer.post-footer .btn i {
            margin-right: 0.25rem !important;
        }

        .followers-container .col-md-6,
        .following-container .col-md-6 {
            padding: 0.5rem;
        }

        .followers-container .user-card,
        .following-container .user-card {
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
        }

        .followers-container .user-card .card-body,
        .following-container .user-card .card-body {
            padding: 1rem !important;
            flex-direction: row !important;
            text-align: left !important;
            align-items: center;
        }

        .followers-container .user-avatar,
        .following-container .user-avatar {
            width: 50px !important;
            height: 50px !important;
            margin: 0 0.75rem 0 0 !important;
        }

        .followers-container .btn-follow,
        .following-container .btn-follow {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            min-width: unset;
            margin-top: 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .container-fluid {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .post-card {
            margin-left: -0.75rem;
            margin-right: -0.75rem;
            border-radius: 0;
        }

        .user-card {
            margin-bottom: 1rem;
        }

        .alert {
            flex-direction: column;
            text-align: center;
        }

        .alert i {
            margin-bottom: 0.75rem;
            margin-right: 0 !important;
        }
    }

    .user-card {
        transition: all 0.2s ease;
        border-radius: 0.75rem;
    }

    .user-avatar {
        border: 3px solid #fff;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
    }

    .post-card {
        border: 0;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
        border-radius: 0.75rem;
        transition: box-shadow 0.2s ease;
    }

    .post-card:hover {
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
    }

    .card-title a:hover {
        color: #0d6efd !important;
    }

    .post-header {
        background-color: transparent;
        border-bottom: 1px solid #f0f0f0;
    }

    .post-footer {
        background-color: transparent;
        border-top: 1px solid #f0f0f0;
    }

    .btn-follow {
        min-width: 120px;
    }

    .posts-container-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .posts-container {
        width: 100%;
        max-width: 800px;
    }

    @media (max-width: 992px) {
        .posts-container {
            max-width: 100%;
        }
    }

    .post-image {
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .post-image img {
        width: 100%;
        height: auto;
        object-fit: cover;
    }
</style>

<div class="page-body">
    <div class="container-fluid">
        <div class="row pb-sm-4 pt-sm-4">
            <div class="card bg-white profile-header mb-4">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-lg-3 col-md-4 col-12 text-center mb-4 mb-md-0">
                            <img src="{{profileUser.avatar}}" alt="{{profileUser.name}}"
                                class="profile-avatar rounded-circle"
                                onerror="this.onerror=null; this.src='/assets/images/avatars/default.png';">

                            {{#ifNotEquals profileUser._id user._id}}
                            <div class="mt-3 d-flex justify-content-center flex-wrap gap-2">
                                {{#if isFollowing}}
                                <button class="btn btn-primary btn-follow" data-user-id="{{profileUser._id}}">
                                    <i class="fas fa-user-check me-1"></i> Đang theo dõi
                                </button>
                                {{else}}
                                <button class="btn btn-primary btn-follow" data-user-id="{{profileUser._id}}">
                                    <i class="fas fa-user-plus me-1"></i> Theo dõi
                                </button>
                                {{/if}}
                            </div>
                            {{/ifNotEquals}}
                            {{#ifEquals profileUser._id user._id}}
                            <div class="mt-3">
                                <a href="/settings" class="btn btn-primary">
                                    <i class="fas fa-cog me-1"></i> Chỉnh sửa hồ sơ
                                </a>
                            </div>
                            {{/ifEquals}}
                        </div>

                        <div class="col-lg-9 col-md-8 col-12">
                            <h2 class="fw-bold mb-1">{{profileUser.name}}</h2>
                            <p class="text-muted mb-3 profile-username">@{{profileUser.username}}</p>

                            <div class="d-flex flex-wrap mb-4">
                                {{#if profileUser.email}}
                                <div class="me-4 mb-2">
                                    <i class="far fa-envelope text-primary me-1"></i> {{profileUser.email}}
                                </div>
                                {{/if}}
                                {{#if profileUser.phone}}
                                <div class="me-4 mb-2">
                                    <i class="fas fa-phone text-primary me-1"></i> {{profileUser.phone}}
                                </div>
                                {{/if}}
                                {{#if profileUser.location}}
                                <div class="me-4 mb-2">
                                    <i class="fas fa-map-marker-alt text-primary me-1"></i> {{profileUser.location}}
                                </div>
                                {{/if}}
                                <div class="mb-2">
                                    <i class="fas fa-user-clock text-primary me-1"></i> Tham gia {{formatDate
                                    profileUser.createdAt "DD/MM/YYYY"}}
                                </div>
                            </div>

                            <div class="profile-stats d-flex justify-content-around mb-3">
                                <div class="stat-item text-center">
                                    <h4 class="fw-bold mb-0">{{profileUser.postCount}}</h4>
                                    <span class="text-muted">Bài viết</span>
                                </div>
                                <div class="stat-item text-center">
                                    <h4 class="fw-bold mb-0">{{profileUser.followers.length}}</h4>
                                    <span class="text-muted">Người theo dõi</span>
                                </div>
                                <div class="stat-item text-center">
                                    <h4 class="fw-bold mb-0">{{profileUser.following.length}}</h4>
                                    <span class="text-muted">Đang theo dõi</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-white p-0">
                    <ul class="nav nav-tabs profile-tabs card-header-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" data-bs-toggle="tab" href="#posts" role="tab">
                                <i class="fas fa-file-alt me-md-2 me-1"></i><span>Bài viết</span>
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="tab" href="#followers" role="tab">
                                <i class="fas fa-users me-md-2 me-1"></i><span>Người theo dõi</span>
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="tab" href="#following" role="tab">
                                <i class="fas fa-user-friends me-md-2 me-1"></i><span>Đang theo dõi</span>
                            </a>
                        </li>
                        {{#ifEquals profileUser._id user._id}}
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" data-bs-toggle="tab" href="#saved" role="tab">
                                <i class="fas fa-bookmark me-md-2 me-1"></i><span>Đã lưu</span>
                            </a>
                        </li>
                        {{/ifEquals}}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="posts" role="tabpanel">
                            {{#if posts.length}}
                            <div class="posts-container-wrapper">
                                <div id="postsContainer" class="posts-container">
                                    {{#each posts}}
                                    <div class="card post-card mb-4" id="post-{{this._id}}">
                                        <div class="card-header post-header py-3">
                                            <div class="d-flex align-items-center w-100">
                                                <img src="{{this.author.avatar}}" class="rounded-circle me-3" width="50"
                                                    height="50" alt="{{this.author.name}}"
                                                    onerror="this.onerror=null; this.src='/assets/images/avatars/default.png';">
                                                <div>
                                                    <h5 class="mb-0">{{this.author.name}}</h5>
                                                    <small class="text-muted">{{formatTimeAgo this.createdAt}}</small>
                                                </div>
                                                <div class="dropdown ms-auto">
                                                    <button class="btn btn-sm btn-primary" type="button"
                                                        data-bs-toggle="dropdown">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end shadow">
                                                        {{#ifEquals this.author._id ../../user._id}}
                                                        <li><a class="dropdown-item"
                                                                href="/discussion/edit/{{this._id}}"><i
                                                                    class="fas fa-edit me-2"></i>Chỉnh sửa</a></li>
                                                        <li><a class="dropdown-item btn-delete-post" href="#"
                                                                data-post-id="{{this._id}}"><i
                                                                    class="fas fa-trash-alt me-2"></i>Xóa</a></li>
                                                        {{else}}
                                                        <li><a class="dropdown-item btn-save-post" href="#"
                                                                data-post-id="{{this._id}}"><i
                                                                    class="fas fa-bookmark me-2"></i>Lưu bài đăng</a>
                                                        </li>
                                                        <li><a class="dropdown-item report-post" href="#"
                                                                data-post-id="{{this._id}}"><i
                                                                    class="fas fa-flag me-2"></i>Báo cáo</a></li>
                                                        {{/ifEquals}}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-4">
                                            <h4 class="card-title mb-3">
                                                <a href="/post/{{this._id}}"
                                                    class="text-decoration-none text-dark">{{this.title}}</a>
                                            </h4>
                                            <p class="card-text">{{{truncate this.content 200}}}</p>
                                            {{#if this.image}}
                                            <div class="post-image mb-3">
                                                <img src="/uploads/posts/{{this.image}}" class="img-fluid rounded"
                                                    alt="Post image">
                                            </div>
                                            {{/if}}
                                            <div class="mb-3">
                                                {{#each this.hashtags}}
                                                <a href="/discussion/tag/{{this.name}}"
                                                    class="badge rounded-pill bg-light text-dark text-decoration-none me-1">#{{this.name}}</a>
                                                {{/each}}
                                            </div>
                                        </div>
                                        <div class="card-footer post-footer d-flex gap-2 p-3">
                                            <button
                                                class="btn btn-sm btn-primary flex-fill btn-like-post {{#if this.isLiked}}active{{/if}}"
                                                data-post-id="{{this._id}}">
                                                <i
                                                    class="{{#if this.isLiked}}fas{{else}}far{{/if}} fa-thumbs-up me-1"></i>
                                                <span class="likes-count">{{this.likes.length}}</span> Thích
                                            </button>
                                            <button class="btn btn-sm btn-secondary flex-fill">
                                                <i class="far fa-comment me-1"></i>
                                                <span class="comments-count">{{this.comments.length}}</span> Bình luận
                                            </button>
                                            <a href="/post/{{this._id}}" class="btn btn-sm btn-info flex-fill">
                                                <i class="fas fa-eye me-1"></i> Xem chi tiết
                                            </a>
                                        </div>
                                    </div>
                                    {{/each}}
                                </div>
                            </div>

                            {{#if hasMorePosts}}
                            <div class="text-center mt-4 mb-3">
                                <button class="btn btn-primary px-4" id="loadMorePosts" data-page="1"
                                    data-user-id="{{profileUser._id}}">
                                    <i class="fas fa-sync me-2"></i>Xem thêm bài đăng
                                </button>
                            </div>
                            {{/if}}
                            {{else}}
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-1">Không có bài viết nào</h5>
                                    {{#ifEquals profileUser._id user._id}}
                                    <p class="mb-3">Bạn chưa tạo bài viết nào.</p>
                                    <a href="/discussion" class="btn btn-primary">
                                        <i class="fas fa-plus-circle me-2"></i> Tạo bài viết mới
                                    </a>
                                    {{else}}
                                    <p class="mb-0">Người dùng này chưa đăng bài viết nào.</p>
                                    {{/ifEquals}}
                                </div>
                            </div>
                            {{/if}}
                        </div>
                        <div class="tab-pane fade" id="followers" role="tabpanel">
                            {{#if followers.length}}
                            <div class="row g-3 followers-container">
                                {{#each followers}}
                                <div class="col-md-6 col-lg-4">
                                    <div class="card h-100 user-card">
                                        <div class="card-body p-4 d-flex align-items-center">
                                            <img src="{{this.avatar}}" alt="{{this.name}}"
                                                class="user-avatar rounded-circle me-3" width="64" height="64"
                                                onerror="this.onerror=null; this.src='/assets/images/avatars/default.png';">
                                            <div>
                                                <h5 class="card-title mb-1">
                                                    <a href="/profile/{{this.username}}"
                                                        class="text-decoration-none">{{this.name}}</a>
                                                </h5>
                                                <p class="text-muted small mb-3">@{{this.username}}</p>
                                                {{#ifNotEquals this._id ../user._id}}
                                                {{#if this.isFollowing}}
                                                <button class="btn btn-sm btn-primary btn-follow"
                                                    data-user-id="{{this._id}}">
                                                    <i class="fas fa-user-check me-1"></i> <span class="btn-text">Đang
                                                        theo dõi</span>
                                                </button>
                                                {{else}}
                                                <button class="btn btn-sm btn-primary btn-follow"
                                                    data-user-id="{{this._id}}">
                                                    <i class="fas fa-user-plus me-1"></i> <span class="btn-text">Theo
                                                        dõi</span>
                                                </button>
                                                {{/if}}
                                                {{/ifNotEquals}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {{/each}}
                            </div>
                            {{else}}
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-1">Không có người theo dõi nào</h5>
                                    <p class="mb-0">Chưa có ai theo dõi trang cá nhân này.</p>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                        <div class="tab-pane fade" id="following" role="tabpanel">
                            {{#if following.length}}
                            <div class="row g-3 following-container">
                                {{#each following}}
                                <div class="col-md-6 col-lg-4">
                                    <div class="card h-100 user-card">
                                        <div class="card-body p-4 d-flex align-items-center">
                                            <img src="{{this.avatar}}" alt="{{this.name}}"
                                                class="user-avatar rounded-circle me-3" width="64" height="64"
                                                onerror="this.onerror=null; this.src='/assets/images/avatars/default.png';">
                                            <div>
                                                <h5 class="card-title mb-1">
                                                    <a href="/profile/{{this.username}}"
                                                        class="text-decoration-none">{{this.name}}</a>
                                                </h5>
                                                <p class="text-muted small mb-3">@{{this.username}}</p>
                                                {{#ifNotEquals this._id ../user._id}}
                                                <button class="btn btn-sm btn-primary btn-follow active"
                                                    data-user-id="{{this._id}}">
                                                    <i class="fas fa-user-check me-1"></i> <span class="btn-text">Đang
                                                        theo dõi</span>
                                                </button>
                                                {{/ifNotEquals}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {{/each}}
                            </div>
                            {{else}}
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-1">Không theo dõi ai</h5>
                                    <p class="mb-0">Người dùng này chưa theo dõi ai.</p>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                        {{#ifEquals profileUser._id user._id}}
                        <div class="tab-pane fade" id="saved" role="tabpanel">
                            {{#if savedPosts.length}}
                            <div class="posts-container-wrapper">
                                <div id="savedPostsContainer" class="posts-container">
                                    {{#each savedPosts}}
                                    <div class="card post-card mb-4">
                                        <div class="card-header post-header py-3">
                                            <div class="d-flex align-items-center w-100">
                                                <img src="{{this.author.avatar}}" class="rounded-circle me-3" width="50"
                                                    height="50" alt="{{this.author.name}}"
                                                    onerror="this.onerror=null; this.src='/assets/images/avatars/default.png';">
                                                <div>
                                                    <h5 class="mb-0">{{this.author.name}}</h5>
                                                    <small class="text-muted">{{formatTimeAgo this.createdAt}}</small>
                                                </div>
                                                <div class="dropdown ms-auto">
                                                    <button class="btn btn-sm btn-light rounded-circle" type="button"
                                                        data-bs-toggle="dropdown">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end shadow">
                                                        <li><a class="dropdown-item btn-unsave-post" href="#"
                                                                data-post-id="{{this._id}}">
                                                                <i class="fas fa-bookmark-slash me-2"></i>Bỏ lưu bài
                                                                đăng</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-4">
                                            <h4 class="card-title mb-3">
                                                <a href="/post/{{this._id}}"
                                                    class="text-decoration-none text-dark">{{this.title}}</a>
                                            </h4>
                                            <p class="card-text">{{{truncate this.content 200}}}</p>
                                            {{#if this.image}}
                                            <div class="post-image mb-3">
                                                <img src="/uploads/posts/{{this.image}}" class="img-fluid rounded"
                                                    alt="Post image">
                                            </div>
                                            {{/if}}
                                        </div>
                                        <div class="card-footer post-footer p-3">
                                            <div class="d-grid">
                                                <a href="/post/{{this._id}}" class="btn btn-primary">
                                                    <i class="fas fa-eye me-2"></i> Xem bài viết
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    {{/each}}
                                </div>
                            </div>
                            {{else}}
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle fa-2x me-3"></i>
                                <div>
                                    <h5 class="mb-1">Chưa có bài viết đã lưu</h5>
                                    <p class="mb-0">Bạn chưa lưu bài viết nào.</p>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                        {{/ifEquals}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/assets/js/profile.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (window.innerWidth <= 576) {
            document.querySelectorAll('.user-card .card-body').forEach(card => {
            });
        }

        document.querySelectorAll('.profile-tabs .nav-link').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.profile-tabs .nav-link').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
            });
        });

        const loadMoreBtn = document.getElementById('loadMorePosts');
        if (loadMoreBtn) {
            const originalLoadMore = loadMoreBtn.onclick;
            loadMoreBtn.onclick = function () {
                if (originalLoadMore) {
                    originalLoadMore.apply(this);
                }
                setTimeout(() => {
                    const postsContainer = document.getElementById('postsContainer');
                    if (!postsContainer.classList.contains('posts-container')) {
                        postsContainer.classList.add('posts-container');
                        const wrapper = document.createElement('div');
                        wrapper.className = 'posts-container-wrapper';
                        postsContainer.parentNode.insertBefore(wrapper, postsContainer);
                        wrapper.appendChild(postsContainer);
                    }
                }, 500);
            };
        }
        function adjustFollowButtonText() {
            if (window.innerWidth <= 380) {
                document.querySelectorAll('.btn-follow .btn-text').forEach(span => {
                    if (span.textContent === 'Đang theo dõi') {
                        span.textContent = 'Đang theo';
                    }
                });
            }
        }

        adjustFollowButtonText();
        window.addEventListener('resize', adjustFollowButtonText);
    });
</script>